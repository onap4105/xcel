In Kubespray, the `admin.crt` and `admin.key` files are not generated by default because Kubespray primarily uses the `admin.conf` kubeconfig file (located at `/etc/kubernetes/admin.conf`) for cluster administration. This file embeds the client certificate and key for the `admin` user in Base64-encoded format. However, if you explicitly want separate `admin.crt` and `admin.key` files, you can configure Kubespray to generate them during installation. Here's how:

---

### **1. Configure Kubespray to Generate `admin.crt` and `admin.key`**
Kubespray uses Ansible variables to control certificate generation. To generate standalone `admin` certificates:
- Modify the `kubespray/inventory/<your_cluster>/group_vars/k8s_cluster/k8s-cluster.yml` file.

Add or update the following variables:
```yaml
# Ensure certificates are generated for the "admin" user
kube_cert_group: system:masters  # Organization (O) for the admin certificate
generate_admin_certificate: true  # Explicitly enable admin cert/key generation
```

---

### **2. Verify Certificate Generation Tasks**
Kubespray’s certificate generation is handled by the `kubernetes/secrets` role. Ensure the role includes tasks for admin certificates by checking:
- The role `roles/kubernetes/secrets/tasks/check_certs.yml` ensures certificates are generated.
- The variable `generate_admin_certificate: true` triggers the creation of `admin.crt` and `admin.key`.

---

### **3. Run the Kubespray Playbook**
After updating the configuration, re-run the Kubespray playbook to apply changes:
```bash
ansible-playbook -i inventory/<your_cluster>/hosts.yaml cluster.yml
```

---

### **4. Locate the Generated Files**
After installation, the `admin.crt` and `admin.key` files will be created on the control plane nodes at:
```bash
/etc/kubernetes/ssl/admin.crt
/etc/kubernetes/ssl/admin.key
```

---

### **5. Extract Certificates from `admin.conf` (Alternative)**
If Kubespray still does not generate standalone files, extract the certificate and key from the `admin.conf` kubeconfig:
```bash
# Extract client certificate
kubectl config view --raw -o jsonpath='{.users[?(@.name == "admin")].user.client-certificate-data}' | base64 -d > admin.crt

# Extract client private key
kubectl config view --raw -o jsonpath='{.users[?(@.name == "admin")].user.client-key-data}' | base64 -d > admin.key
```

---

### **6. Manually Generate Admin Certificates (Fallback)**
If Kubespray still does not generate the files, create them manually using the cluster’s CA:

#### **Step 1: Generate CSR and Key**
```bash
openssl genrsa -out admin.key 2048
openssl req -new -key admin.key -out admin.csr -subj "/CN=admin/O=system:masters"
```

#### **Step 2: Sign with Cluster CA**
```bash
openssl x509 -req -in admin.csr \
  -CA /etc/kubernetes/ssl/ca.crt \
  -CAkey /etc/kubernetes/ssl/ca.key \
  -CAcreateserial -out admin.crt -days 365
```

#### **Step 3: Update Kubeconfig**
```bash
kubectl config set-credentials admin \
  --client-certificate=admin.crt \
  --client-key=admin.key \
  --embed-certs=true
```

---

### **Why Kubespray Might Not Generate `admin.crt` and `admin.key` by Default**
Kubespray prioritizes security and simplicity by:
- Embedding credentials directly in `admin.conf` (Base64-encoded).
- Avoiding redundant certificate files unless explicitly requested.

---

### **Key Configuration Variables**
| Variable                     | Purpose                                                                 |
|------------------------------|-------------------------------------------------------------------------|
| `generate_admin_certificate` | Set to `true` to generate standalone `admin.crt` and `admin.key`.       |
| `kube_cert_group`            | Defines the Organization (`O`) for the admin certificate (e.g., `system:masters`). |

---

### **Post-Installation Verification**
```bash
# Check if files exist
ls /etc/kubernetes/ssl/admin.*

# Test admin access
kubectl --certificate-authority=/etc/kubernetes/ssl/ca.crt \
  --client-certificate=/etc/kubernetes/ssl/admin.crt \
  --client-key=/etc/kubernetes/ssl/admin.key \
  get nodes
```

---

By configuring `generate_admin_certificate: true`, Kubespray will generate the required `admin.crt` and `admin.key` files during installation. If not, use the manual extraction or generation steps to obtain them.
